name: CI

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        env:
          VERSION: v0.6.7
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/${VERSION}/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          find k8s -name '*.yaml' -print0 | xargs -0 kubeconform \
            -kubernetes-version 1.32.0 \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -summary \
            -verbose

  helm-lint:
    name: Lint Helm charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Helm charts
        run: |
          for chart in charts/*/; do
            [ -d "$chart" ] || continue
            echo "--- Linting $chart ---"
            helm lint "$chart"
          done

  helm-validate:
    name: Validate rendered Helm templates
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        env:
          VERSION: v0.6.7
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/${VERSION}/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate rendered Helm templates
        run: |
          for chart in charts/*/; do
            [ -d "$chart" ] || continue
            echo "--- Validating rendered templates: $chart ---"
            helm template "$chart" | kubeconform \
              -kubernetes-version 1.32.0 \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
              -summary \
              -verbose
          done
